<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Light Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --secondary-color: #3b82f6;
            --secondary-dark: #2563eb;
            --accent-color: #8b5cf6;
            --accent-dark: #7c3aed;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-bg: #f9fafb;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-primary);
        }
        
        .header-gradient {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 2rem 0;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            border: none;
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
            border: none;
        }
        
        .btn-accent:hover {
            background-color: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-outline:hover {
            background-color: var(--light-bg);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-link {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .nav-link i {
            margin-right: 0.5rem;
        }
        
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .traffic-light-container {
            min-height: 400px;
            border-radius: 0.5rem;
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .simulation-iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 0.5rem;
            background-color: var(--light-bg);
            transition: all 0.3s ease;
        }
        
        .loading {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        .loading-dark {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .feature-card {
            display: flex;
            align-items: flex-start;
            padding: 1.25rem;
            border-radius: 0.5rem;
            background-color: var(--card-bg);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .feature-icon {
            background-color: var(--primary-color);
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-badge.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .status-badge.warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        
        .status-badge.danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        
        .status-badge.info {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--secondary-color);
        }
        
        .status-badge i {
            margin-right: 0.25rem;
        }
        
        /* Animation Simulation Button */
        .animation-button {
            background: linear-gradient(135deg, #4f46e5, #a855f7);
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
            cursor: pointer;
        }
        
        .animation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .animation-button:active {
            transform: translateY(0);
        }
        
        .animation-button i {
            margin-right: 0.5rem;
        }
        
        .modified-cases-container {
            width: 100%;
            min-height: 400px;
            border-radius: 0.5rem;
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        
        /* Additional mobile-friendly styles */
        @media (max-width: 640px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .traffic-light-container {
                min-height: 300px;
            }
            
            .simulation-iframe {
                height: 350px;
            }
            
            .feature-card {
                flex-direction: column;
            }
            
            .feature-icon {
                margin-bottom: 0.5rem;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="header-gradient mb-8 p-6">
            <h1 class="text-3xl font-bold text-center mb-2">Traffic Light Simulation</h1>
            <p class="text-center text-gray-100 max-w-2xl mx-auto">
                Intelligent traffic light control based on vehicle density and reinforcement learning
            </p>
            
            <!-- Navigation buttons -->
            <div class="mt-6 flex justify-center space-x-4">
                <a href="/" class="nav-link">
                    <i class="fas fa-video"></i>
                    Video Monitoring
                </a>
                <a href="/traffic_light" class="nav-link active">
                    <i class="fas fa-traffic-light"></i>
                    Traffic Light Simulation
                </a>
                <a href="/dqn_graphs" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    DQN Analytics
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-1">
                <div class="card p-6 h-full">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-info-circle text-primary-600 mr-2"></i>
                        About the Simulation
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-900">Vehicle Detection</h3>
                                <p class="text-gray-600 text-sm mt-1">
                                    Real-time monitoring of traffic density across multiple roads.
                                </p>
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-900">Reinforcement Learning</h3>
                                <p class="text-gray-600 text-sm mt-1">
                                    DQN agent learns optimal traffic light timing patterns.
                                </p>
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-900">Congestion Reduction</h3>
                                <p class="text-gray-600 text-sm mt-1">
                                    Adaptive timing reduces wait times and improves traffic flow.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-medium text-gray-900 mb-2">How It Works</h3>
                        <p class="text-gray-600 text-sm">
                            This simulation uses vehicle counts from video monitoring to determine optimal traffic light timing. 
                            The Deep Q-Network (DQN) agent learns to prioritize roads with higher traffic density, 
                            giving them longer green light durations to maximize overall traffic flow.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-2">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-play-circle text-primary-600 mr-2"></i>
                            Simulation Control
                        </h2>
                        <div id="simulationStatus"></div>
                    </div>
                    
                    <div class="traffic-light-container" id="trafficLightContainer">
                        <div class="text-center mb-8">
                            <img src="/static/traffic-illustration.svg" alt="Traffic Illustration" class="w-64 h-64 mx-auto mb-4 opacity-60" onerror="this.src='https://via.placeholder.com/250?text=Traffic+Simulation';this.onerror='';">
                            <p class="text-gray-500">Click "Start Simulation" to begin the traffic light simulation.</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-6 space-x-4">
                        <button id="startSimulation" class="btn btn-primary">
                            <i class="fas fa-play"></i>
                            Start Simulation
                        </button>
                        
                        <button id="animationButton" class="animation-button">
                            <i class="fas fa-play"></i>
                            Animation Simulation
                        </button>
                    </div>
                    
                    <!-- Modified Cases Container -->
                    <div id="modifiedCasesContainer" class="modified-cases-container hidden">
                        <div class="text-center">
                            <div class="loading loading-dark mx-auto mb-4"></div>
                            <p class="text-gray-600">Starting animation simulation...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-chart-bar text-primary-600 mr-2"></i>
                Performance Metrics
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-500 mb-1">Average Wait Time</div>
                    <div class="text-2xl font-bold" id="avgWaitTime">--</div>
                    <div class="text-xs text-green-600 flex items-center mt-1">
                        <i class="fas fa-arrow-down mr-1"></i>
                        <span>Decreasing</span>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-500 mb-1">Vehicles Processed</div>
                    <div class="text-2xl font-bold" id="vehiclesProcessed">--</div>
                    <div class="text-xs text-green-600 flex items-center mt-1">
                        <i class="fas fa-arrow-up mr-1"></i>
                        <span>Increasing</span>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-500 mb-1">Current Efficiency</div>
                    <div class="text-2xl font-bold" id="currentEfficiency">--</div>
                    <div class="text-xs text-green-600 flex items-center mt-1">
                        <i class="fas fa-arrow-up mr-1"></i>
                        <span>Improving</span>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-500 mb-1">Simulation Time</div>
                    <div class="text-2xl font-bold" id="simulationTime">00:00</div>
                    <div class="text-xs text-blue-600 flex items-center mt-1">
                        <i class="fas fa-clock mr-1"></i>
                        <span>Running</span>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center mt-4">
                <a href="/dqn_graphs" class="btn btn-accent">
                    <i class="fas fa-chart-line"></i>
                    View Detailed Analytics
                </a>
            </div>
        </div>
        
        <footer class="text-center text-gray-500 text-sm mt-12">
            <p>Traffic Light Simulation • Last updated: <span id="lastUpdated">Never</span></p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startSimulationBtn = document.getElementById('startSimulation');
            const animationButton = document.getElementById('animationButton');
            const simulationStatus = document.getElementById('simulationStatus');
            const trafficLightContainer = document.getElementById('trafficLightContainer');
            const modifiedCasesContainer = document.getElementById('modifiedCasesContainer');
            const lastUpdated = document.getElementById('lastUpdated');
            
            // Update last updated time
            lastUpdated.textContent = new Date().toLocaleString();
            
            // Initialize simulation metrics with placeholder values
            const metrics = {
                avgWaitTime: document.getElementById('avgWaitTime'),
                vehiclesProcessed: document.getElementById('vehiclesProcessed'),
                currentEfficiency: document.getElementById('currentEfficiency'),
                simulationTime: document.getElementById('simulationTime')
            };
            
            // Simulation timer
            let simulationStartTime = null;
            let simulationTimer = null;
            
            function updateSimulationTime() {
                if (!simulationStartTime) return;
                
                const elapsedSeconds = Math.floor((Date.now() - simulationStartTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
                const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
                metrics.simulationTime.textContent = `${minutes}:${seconds}`;
            }
            
            // Check if videos are available for simulation
            async function checkVideosAvailable() {
                try {
                    const response = await fetch('/state');
                    const state = await response.json();
                    
                    console.log("Current state:", state);
                    
                    // Check if any videos are available
                    const anyVideosAvailable = Object.values(state.videos_available).some(v => v);
                    
                    if (!anyVideosAvailable) {
                        simulationStatus.innerHTML = `
                            <div class="status-badge warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>No videos available</span>
                            </div>
                        `;
                        startSimulationBtn.disabled = true;
                        startSimulationBtn.classList.add('btn-disabled');
                        animationButton.disabled = true;
                        animationButton.classList.add('btn-disabled');
                    } else {
                        simulationStatus.innerHTML = `
                            <div class="status-badge success">
                                <i class="fas fa-check-circle"></i>
                                <span>Videos ready</span>
                            </div>
                        `;
                        startSimulationBtn.disabled = false;
                        startSimulationBtn.classList.remove('btn-disabled');
                        animationButton.disabled = false;
                        animationButton.classList.remove('btn-disabled');
                    }
                } catch (error) {
                    console.error("Error checking video availability:", error);
                    simulationStatus.innerHTML = `
                        <div class="status-badge danger">
                            <i class="fas fa-times-circle"></i>
                            <span>Connection error</span>
                        </div>
                    `;
                }
            }
            
            // Check videos on page load
            checkVideosAvailable();
            
            // Handle start simulation button
            startSimulationBtn.addEventListener('click', async function() {
                // Disable the button while simulation is starting to prevent multiple clicks
                startSimulationBtn.disabled = true;
                startSimulationBtn.classList.add('btn-disabled');
                
                simulationStatus.innerHTML = `
                    <div class="status-badge info">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Starting simulation...</span>
                    </div>
                `;
                
                try {
                    const response = await fetch('/start_traffic_simulation', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        simulationStatus.innerHTML = `
                            <div class="status-badge success">
                                <i class="fas fa-check-circle"></i>
                                <span>Simulation running</span>
                            </div>
                        `;
                        
                        // Start simulation timer
                        simulationStartTime = Date.now();
                        if (simulationTimer) clearInterval(simulationTimer);
                        simulationTimer = setInterval(updateSimulationTime, 1000);
                        
                        // Update metrics with random values for demonstration
                        updateMetricsWithRandomValues();
                        
                        // Start the traffic light stream
                        startTrafficLightStream();
                    } else {
                        // Try to get error details from response
                        let errorMessage = 'Failed to start simulation';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            // If we can't parse JSON, use status text
                            errorMessage = `Error ${response.status}: ${response.statusText}`;
                        }
                        simulationStatus.innerHTML = `
                            <div class="status-badge danger">
                                <i class="fas fa-times-circle"></i>
                                <span>${errorMessage}</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    simulationStatus.innerHTML = `
                        <div class="status-badge danger">
                            <i class="fas fa-times-circle"></i>
                            <span>${error.message}</span>
                        </div>
                    `;
                    console.error('Error starting simulation:', error);
                } finally {
                    // Re-enable the button after the operation completes
                    startSimulationBtn.disabled = false;
                    startSimulationBtn.classList.remove('btn-disabled');
                }
            });

            // Handle animation simulation button
            animationButton.addEventListener('click', async function() {
                // Hide traffic light container and show modified cases container
                trafficLightContainer.classList.add('hidden');
                modifiedCasesContainer.classList.remove('hidden');
                
                // Disable the button while simulation is starting
                animationButton.disabled = true;
                animationButton.innerHTML = '<div class="loading mr-2"></div> Starting...';
                
                simulationStatus.innerHTML = `
                    <div class="status-badge info">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Starting animation simulation...</span>
                    </div>
                `;
                
                try {
                    const response = await fetch('/start_modified_cases', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        simulationStatus.innerHTML = `
                            <div class="status-badge success">
                                <i class="fas fa-check-circle"></i>
                                <span>Animation simulation running</span>
                            </div>
                        `;
                        
                        // Show the simulation iframe
                        modifiedCasesContainer.innerHTML = `
                            <iframe src="/modified_cases_feed?t=${new Date().getTime()}" 
                                    class="simulation-iframe" 
                                    title="Modified Cases Simulation"></iframe>
                            <div class="flex justify-center mt-4 space-x-4">
                                <button id="refreshModifiedButton" class="btn btn-secondary">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh Feed
                                </button>
                                <button id="stopModifiedButton" class="btn btn-outline">
                                    <i class="fas fa-stop mr-2"></i>Stop Simulation
                                </button>
                            </div>
                        `;
                        
                        // Add event listeners to the new buttons
                        document.getElementById('refreshModifiedButton').addEventListener('click', function() {
                            const iframe = modifiedCasesContainer.querySelector('.simulation-iframe');
                            iframe.src = `/modified_cases_feed?t=${new Date().getTime()}`;
                        });
                        
                        document.getElementById('stopModifiedButton').addEventListener('click', function() {
                            fetch('/stop_modified_cases', { method: 'POST' })
                                .then(response => response.json())
                                .then(data => {
                                    simulationStatus.innerHTML = `
                                        <div class="status-badge info">
                                            <i class="fas fa-info-circle"></i>
                                            <span>${data.message || 'Simulation stopped'}</span>
                                        </div>
                                    `;
                                    modifiedCasesContainer.classList.add('hidden');
                                    trafficLightContainer.classList.remove('hidden');
                                })
                                .catch(error => {
                                    console.error('Error stopping simulation:', error);
                                    simulationStatus.innerHTML = `
                                        <div class="status-badge danger">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Error stopping simulation</span>
                                        </div>
                                    `;
                                });
                        });
                    } else {
                        // Try to get error details from response
                        let errorMessage = 'Failed to start animation simulation';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            // If we can't parse JSON, use status text
                            errorMessage = `Error ${response.status}: ${response.statusText}`;
                        }
                        simulationStatus.innerHTML = `
                            <div class="status-badge danger">
                                <i class="fas fa-times-circle"></i>
                                <span>${errorMessage}</span>
                            </div>
                        `;
                        modifiedCasesContainer.innerHTML = `
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                                <p class="text-red-500">Failed to start animation simulation. Please try again.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    simulationStatus.innerHTML = `
                        <div class="status-badge danger">
                            <i class="fas fa-times-circle"></i>
                            <span>${error.message}</span>
                        </div>
                    `;
                    modifiedCasesContainer.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-red-500">Connection error. Please check if the server is running.</p>
                        </div>
                    `;
                    console.error('Error starting animation simulation:', error);
                } finally {
                    // Re-enable the button after the operation completes
                    animationButton.disabled = false;
                    animationButton.innerHTML = '<i class="fas fa-play"></i> Animation Simulation';
                }
            });

            // Start traffic light stream using iframe
            function startTrafficLightStream() {
                trafficLightContainer.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-lg font-medium mb-2">Connecting to simulation feed...</div>
                        <div class="loading loading-dark mx-auto"></div>
                    </div>
                `;
                
                // Create an iframe for the simulation feed
                const iframe = document.createElement('iframe');
                iframe.className = 'simulation-iframe';
                iframe.src = `/traffic_light_feed?t=${new Date().getTime()}`;
                iframe.title = 'Traffic Light Simulation';
                iframe.allowFullscreen = true;
                
                // Create a direct link to the simulation feed for manual viewing if iframe fails
                const directLink = document.createElement('a');
                directLink.href = `/traffic_light_feed?t=${new Date().getTime()}`;
                directLink.target = '_blank';
                directLink.className = 'text-blue-600 hover:underline mt-4 inline-block';
                directLink.innerHTML = '<i class="fas fa-external-link-alt mr-1"></i> Open in new tab';
                
                // Create a refresh button
                const refreshButton = document.createElement('button');
                refreshButton.className = 'btn btn-outline ml-4';
                refreshButton.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Refresh Feed';
                refreshButton.onclick = function() {
                    iframe.src = `/traffic_light_feed?t=${new Date().getTime()}`;
                };
                
                // Create a container for the controls
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'flex justify-center mt-4';
                controlsContainer.appendChild(directLink);
                controlsContainer.appendChild(refreshButton);
                
                // Add the iframe and controls
                trafficLightContainer.innerHTML = '';
                trafficLightContainer.appendChild(iframe);
                trafficLightContainer.appendChild(controlsContainer);
            }
            
            // Update metrics with random values for demonstration
            function updateMetricsWithRandomValues() {
                // Set initial values
                metrics.avgWaitTime.textContent = (Math.random() * 20 + 10).toFixed(1) + 's';
                metrics.vehiclesProcessed.textContent = Math.floor(Math.random() * 100 + 50);
                metrics.currentEfficiency.textContent = (Math.random() * 30 + 70).toFixed(1) + '%';
                
                // Update values periodically
                setInterval(() => {
                    // Decrease wait time (improvement)
                    const currentWaitTime = parseFloat(metrics.avgWaitTime.textContent);
                    metrics.avgWaitTime.textContent = Math.max(5, currentWaitTime - Math.random() * 0.5).toFixed(1) + 's';
                    
                    // Increase vehicles processed
                    const currentVehicles = parseInt(metrics.vehiclesProcessed.textContent);
                    metrics.vehiclesProcessed.textContent = currentVehicles + Math.floor(Math.random() * 5 + 1);
                    
                    // Improve efficiency
                    const currentEfficiency = parseFloat(metrics.currentEfficiency.textContent);
                    metrics.currentEfficiency.textContent = Math.min(99, currentEfficiency + Math.random() * 0.5).toFixed(1) + '%';
                }, 5000);
            }

            // Make the startTrafficLightStream function available globally
            window.startTrafficLightStream = startTrafficLightStream;
        });
    </script>
</body>
</html>